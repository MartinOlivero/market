<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Iamautom Lab ‚Äî Ad Hub</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --brand: 99 102 241; /* indigo-500 */
      --brand-600: 79 70 229; /* indigo-600 */
      --brand-700: 67 56 202; /* indigo-700 */
      --accent: 56 189 248;   /* sky-400 */
    }

    /* ===== Base y fondo (fix scroll + degradado) ===== */
    html { height:auto; }
    body{
      min-height:100vh;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background:#0b1020; /* base s√≥lida */
      color:#fff;
      overflow-x:hidden;   /* evita desbordes cuando llegan prompts largos */
    }
    /* degradado fijo de fondo */
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1; pointer-events:none;
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(147,197,253,.25), transparent 60%),
        radial-gradient(1000px 700px at 90% 0%, rgba(251,146,60,.18), transparent 60%),
        radial-gradient(900px 600px at 50% 100%, rgba(192,132,252,.18), transparent 60%);
    }

    /* tarjetas vidrio */
    .glass{
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
      backdrop-filter: blur(14px);
    }
    .glass-soft{
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
      backdrop-filter: blur(12px);
    }

    .cta{
      background:linear-gradient(135deg, rgb(var(--brand)) 0%, rgb(var(--brand-600)) 45%, rgb(var(--brand-700)) 100%);
      box-shadow:0 8px 24px rgba(79,70,229,.45);
    }
    .cta:hover{ filter:brightness(1.08); }

    .chip{
      display:inline-flex; align-items:center; justify-content:center;
      width:1.5rem; height:1.5rem; font-size:.75rem; font-weight:800;
      border-radius:9999px; color:#fff;
      background:linear-gradient(135deg, rgb(var(--brand)) 0%, rgb(var(--brand-700)) 100%);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.25);
    }

    .input{
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.14);
      color:#fff; border-radius:10px; padding:.75rem .9rem;
      outline:none; transition:.2s;
    }
    .input:focus{
      border-color:rgba(var(--accent)/1);
      box-shadow:0 0 0 6px rgba(56,189,248,.12);
    }
    select.input{ padding-right:2.25rem }

    .hidden-file-input{ opacity:0; position:absolute; inset:0; width:100%; height:100%; cursor:pointer; }

    /* estado */
    #status-message{ min-height:1.5rem }

    /* highlight drop */
    #drop-zone.dragover{ border-color:rgba(56,189,248,1); background:rgba(56,189,248,.06); }

    /* card seleccionada */
    .prompt-card-radio:checked + label{
      border-color: rgb(var(--brand));
      background: linear-gradient(180deg, rgba(99,102,241,.18), rgba(99,102,241,.08));
    }

    /* prompts largos no rompen */
    #prompt-options-container p{ overflow-wrap:anywhere; }

    /* alturas m√≠nimas para evitar saltos */
    #url-preview-container, #drop-zone{ min-height:16rem; }
  </style>
</head>

<body class="flex flex-col items-center justify-center min-h-screen px-4 sm:px-6">

  <main class="w-full max-w-6xl space-y-8">

    <!-- Header -->
    <div class="text-center space-y-4">
      <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight">
        Tu trabajo, <span class="bg-gradient-to-r from-indigo-400 via-sky-400 to-fuchsia-400 bg-clip-text text-transparent">sincronizado</span>.
      </h1>
      <p class="text-base sm:text-lg text-white/70 max-w-2xl mx-auto">
        Un hub simple de <span class="font-semibold">Iamautom Lab</span> para transformar im√°genes o links en videos din√°micos‚Äîr√°pido.
      </p>
      <div class="mx-auto max-w-3xl text-sm text-white/60 glass-soft p-3">
        Si peg√°s una URL, asegurate que tenga <code class="text-white/80">og:image</code>. Si no, sub√≠ una imagen manualmente.
      </div>
    </div>

    <div id="main-content">
      <form id="n8n-form" class="space-y-8">
        <!-- Paso 1 -->
        <div class="glass p-6">
          <h2 class="text-xl font-semibold mb-4 flex items-center gap-3">
            <span class="chip">1</span>
            Eleg√≠ tu imagen
          </h2>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
            <!-- Upload -->
            <div id="drop-zone" class="relative flex flex-col items-center justify-center min-h-64 border border-white/15 rounded-xl cursor-pointer glass-soft p-2 transition-colors">
              <div id="upload-prompt" class="flex flex-col items-center justify-center pt-6 pb-7 text-center">
                <svg class="w-9 h-9 mb-3 text-white/50" viewBox="0 0 20 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                </svg>
                <p class="mb-1 text-sm text-white/70"><span class="font-semibold">Hac√© clic para subir</span> o arrastr√° y solt√°</p>
                <p class="text-xs text-white/50">JPG, PNG o WEBP</p>
              </div>
              <img id="image-preview" src="" class="hidden absolute inset-0 w-full h-full object-contain rounded-lg" alt="Vista previa de la imagen">
              <input id="file-input" type="file" class="hidden-file-input" accept=".jpg,.jpeg,.png,.webp">
            </div>

            <!-- URL -->
            <div class="min-h-64 flex flex-col">
              <label for="url-input" class="block text-sm font-medium text-white/80 mb-2">O peg√° la URL de una p√°gina</label>
              <div class="flex items-start gap-2">
                <input type="url" id="url-input" class="input w-full" placeholder="https://tu-sitio.com/pagina"/>
                <button type="button" id="fetch-button" class="flex-shrink-0 px-4 py-2.5 text-sm font-semibold text-white rounded-lg cta disabled:opacity-60 disabled:cursor-wait">
                  <span id="fetch-button-text">Obtener imagen</span>
                  <div id="fetch-spinner" class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white mx-auto"></div>
                </button>
              </div>
              <div id="url-feedback" class="mt-2 text-xs text-white/60 h-8">
                Ingres√° una URL y hac√© clic en ‚ÄúObtener imagen‚Äù.
              </div>

              <div id="url-preview-container" class="mt-2 flex-grow flex items-center justify-center border border-white/10 rounded-lg glass-soft p-2">
                <span id="url-preview-placeholder" class="text-white/50 text-sm">La vista previa aparecer√° ac√°</span>
                <img id="url-preview-img" src="" class="hidden w-full h-full object-contain rounded-lg" alt="Vista previa de la URL">
              </div>
            </div>
          </div>
        </div>

        <!-- Paso 2 -->
        <div id="analyze-section" class="hidden glass p-6">
          <h2 class="text-xl font-semibold mb-4 flex items-center gap-3">
            <span class="chip">2</span>
            Analizar imagen
          </h2>
          <p class="text-center text-white/70 mb-4">Analiz√° la imagen para generar sugerencias de prompts autom√°ticamente.</p>
          <div class="text-center">
            <button id="analyze-button" type="button" class="px-8 py-3 font-medium rounded-lg cta disabled:opacity-60 disabled:cursor-wait">
              <span id="analyze-button-text">Analizar imagen y obtener prompts</span>
              <div id="analyze-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>
            </button>
          </div>
        </div>

        <!-- Paso 3 -->
        <div id="video-size-section" class="hidden glass p-6">
          <h2 class="text-xl font-semibold mb-4 flex items-center gap-3">
            <span class="chip">3</span>
            Eleg√≠ el tama√±o del video
          </h2>
          <select id="aspect-ratio-select" class="input w-full">
            <option value="16:9">Horizontal (16:9)</option>
            <option value="9:16">Vertical (9:16)</option>
          </select>
        </div>

        <!-- Paso 4 -->
        <div id="advanced-options-section" class="hidden glass p-6">
          <h2 class="text-xl font-semibold mb-4 flex items-center gap-3">
            <span class="chip">4</span>
            Opciones avanzadas
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label for="model-select" class="block text-sm font-medium text-white/80 mb-2">Modelo</label>
              <select id="model-select" class="input w-full">
                <option value="veo3_fast" selected>veo3_fast</option>
                <option value="veo3">veo3</option>
              </select>
            </div>
            <div>
              <label for="seed-input" class="block text-sm font-medium text-white/80 mb-2">Seed (opcional)</label>
              <input type="text" id="seed-input" class="input w-full"/>
            </div>
            <div>
              <label for="watermark-input" class="block text-sm font-medium text-white/80 mb-2">Marca de agua</label>
              <input type="text" id="watermark-input" class="input w-full" placeholder="Iamautom Lab"/>
            </div>
          </div>
        </div>

        <!-- Paso 5 -->
        <div id="prompt-section" class="hidden glass p-6">
          <h2 class="text-xl font-semibold mb-4 flex items-center gap-3">
            <span class="chip">5</span>
            Eleg√≠ tu prompt
          </h2>
          <div id="prompt-options-container" class="space-y-4"></div>
        </div>

        <!-- Final -->
        <div class="flex flex-col items-center justify-center space-y-4 pt-2">
          <button id="submit-button" type="button" class="w-full md:w-auto text-white font-semibold rounded-full text-lg px-12 py-3.5 cta transition disabled:opacity-60 disabled:cursor-not-allowed">
            <span id="button-text">üöÄ Crear Video</span>
            <div id="loading-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>
          </button>
        </div>
      </form>
    </div>

    <!-- Progreso -->
    <div id="check-progress-section" class="hidden text-center space-y-4 glass p-6">
      <h2 class="text-2xl font-bold">El video se est√° procesando...</h2>
      <p class="text-white/70">Tu video fue enviado. Este proceso puede tardar unos 5 minutos.</p>
      <p id="job-id-display" class="text-sm text-white/60 font-mono"></p>
      <p class="text-white/70">Pod√©s chequear el progreso manualmente:</p>
      <div class="flex items-center justify-center gap-3 flex-wrap">
        <button id="check-progress-button" type="button" class="px-8 py-3 font-medium rounded-lg bg-emerald-600 hover:brightness-110 shadow-md focus:outline-none focus:ring-4 focus:ring-emerald-800 disabled:opacity-60 disabled:cursor-wait">
          <span id="check-progress-text">Ver progreso del video</span>
          <div id="check-progress-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>
        </button>
        <button id="start-over-button" type="button" class="px-8 py-3 font-medium rounded-lg bg-white/10 border border-white/15 hover:bg-white/15">
          Empezar de nuevo
        </button>
      </div>
    </div>

    <div id="status-message" class="text-center text-sm"></div>
  </main>

  <footer class="text-center mt-10 pb-6">
    <p class="text-sm text-white/60">
      Desarrollado por <span class="font-medium text-white/80">Iamautom Lab</span>
      ¬∑ <a href="https://iamautom.com" target="_blank" rel="noopener noreferrer" class="text-sky-300 hover:underline">iamautom.com</a>
    </p>
  </footer>

  <!-- Modal de video -->
  <div id="video-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div id="video-modal-backdrop" class="fixed inset-0 bg-black/70" aria-hidden="true"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
      <div id="video-modal-panel" class="inline-block align-bottom glass text-left overflow-hidden transform sm:my-8 sm:align-middle sm:max-w-xl sm:w-full">
        <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
              <h3 class="text-lg leading-6 font-semibold">¬°Tu video est√° listo!</h3>
              <div class="mt-4">
                <video id="video-player" class="w-full rounded-lg" controls autoplay>
                  Tu navegador no soporta el tag de video.
                </video>
              </div>
            </div>
          </div>
        </div>
        <div class="px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse items-center bg-white/5 border-t border-white/10">
          <button id="resize-video-button" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-white/15 shadow-sm px-4 py-2 bg-indigo-600 font-medium hover:brightness-110 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Cambiar tama√±o
          </button>
          <button id="close-modal-button" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-white/15 shadow-sm px-4 py-2 bg-white/10 font-medium hover:bg-white/15 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ======================= JS ======================= -->
  <script>
    // Webhooks n8n (no tocar)
    const PROMPT_GENERATION_WEBHOOK_URL = "https://n8n.iamautom.com/webhook-test/228a70a2-4547-479a-ad70-1c63030ee627";
    const CREATE_VIDEO_WEBHOOK_URL      = "https://n8n.iamautom.com/webhook-test/fd814769-4357-4862-b216-d2ddeda4959c";
    const VIDEO_STATUS_WEBHOOK_URL      = "https://n8n.iamautom.com/webhook-test/747cfa45-8142-438d-9cac-fee92c30d213";

    document.addEventListener('DOMContentLoaded', () => {
      // DOM
      const mainContent = document.getElementById('main-content');
      const form = document.getElementById('n8n-form');
      const dropZone = document.getElementById('drop-zone');
      const fileInput = document.getElementById('file-input');
      const imagePreview = document.getElementById('image-preview');
      const uploadPrompt = document.getElementById('upload-prompt');
      const urlInput = document.getElementById('url-input');
      const fetchButton = document.getElementById('fetch-button');
      const fetchButtonText = document.getElementById('fetch-button-text');
      const fetchSpinner = document.getElementById('fetch-spinner');
      const urlFeedback = document.getElementById('url-feedback');
      const urlPreviewContainer = document.getElementById('url-preview-container');
      const urlPreviewPlaceholder = document.getElementById('url-preview-placeholder');
      const urlPreviewImg = document.getElementById('url-preview-img');

      const analyzeSection = document.getElementById('analyze-section');
      const analyzeButton = document.getElementById('analyze-button');
      const analyzeButtonText = document.getElementById('analyze-button-text');
      const analyzeSpinner = document.getElementById('analyze-spinner');

      const videoSizeSection = document.getElementById('video-size-section');
      const aspectRatioSelect = document.getElementById('aspect-ratio-select');

      const advancedOptionsSection = document.getElementById('advanced-options-section');
      const modelSelect = document.getElementById('model-select');
      const seedInput = document.getElementById('seed-input');
      const watermarkInput = document.getElementById('watermark-input');

      const promptSection = document.getElementById('prompt-section');
      const promptOptionsContainer = document.getElementById('prompt-options-container');

      const submitButton = document.getElementById('submit-button');
      const buttonText = document.getElementById('button-text');
      const loadingSpinner = document.getElementById('loading-spinner');
      const statusMessage = document.getElementById('status-message');

      const checkProgressSection = document.getElementById('check-progress-section');
      const jobIdDisplay = document.getElementById('job-id-display');
      const checkProgressButton = document.getElementById('check-progress-button');
      const checkProgressText = document.getElementById('check-progress-text');
      const checkProgressSpinner = document.getElementById('check-progress-spinner');
      const startOverButton = document.getElementById('start-over-button');

      const videoModal = document.getElementById('video-modal');
      const videoModalPanel = document.getElementById('video-modal-panel');
      const videoPlayer = document.getElementById('video-player');
      const closeModalButton = document.getElementById('close-modal-button');
      const resizeVideoButton = document.getElementById('resize-video-button');

      // Estado
      let currentJobId = null;
      let appState = { image:null, source:null, prompt:null };

      // Helpers UI
      function setFetchLoading(b){ fetchButton.disabled=b; fetchButtonText.classList.toggle('hidden', b); fetchSpinner.classList.toggle('hidden', !b); }
      function setAnalyzeLoading(b){ analyzeButton.disabled=b; analyzeButtonText.classList.toggle('hidden', b); analyzeSpinner.classList.toggle('hidden', !b); }
      function setLoading(b){ submitButton.disabled=b; buttonText.classList.toggle('hidden', b); loadingSpinner.classList.toggle('hidden', !b); }
      function setCheckProgressLoading(b){ checkProgressButton.disabled=b; checkProgressText.classList.toggle('hidden', b); checkProgressSpinner.classList.toggle('hidden', !b); }

      function showStatus(message, type){
        statusMessage.textContent = message;
        statusMessage.className = 'text-center text-sm';
        if(type==='success') statusMessage.classList.add('text-emerald-400');
        if(type==='error')   statusMessage.classList.add('text-rose-400');
        if(type==='loading') statusMessage.classList.add('text-sky-400');
      }

      function clearUrlState(){
        urlPreviewImg.src=''; urlPreviewImg.classList.add('hidden');
        urlPreviewPlaceholder.classList.remove('hidden');
        urlFeedback.textContent = 'Ingres√° una URL y hac√© clic en ‚ÄúObtener imagen‚Äù.';
        urlFeedback.className = 'mt-2 text-xs text-white/60 h-8';
      }

      function handleImageSelection(){
        promptSection.classList.add('hidden');
        videoSizeSection.classList.add('hidden');
        advancedOptionsSection.classList.add('hidden');
        analyzeSection.classList.remove('hidden');
        submitButton.disabled = true;
      }

      function handleFile(file){
        if(!file || !file.type.match('image/(jpeg|png|webp)')){
          showStatus('Eleg√≠ un archivo JPG, PNG o WEBP.', 'error'); return;
        }
        urlInput.value=''; clearUrlState();
        appState.source='upload';
        const reader = new FileReader();
        reader.onload = (e)=>{
          imagePreview.src = e.target.result;
          imagePreview.classList.remove('hidden');
          uploadPrompt.classList.add('hidden');
          appState.image = e.target.result;
          handleImageSelection();
        };
        reader.readAsDataURL(file);
      }

      // Drag & drop
      dropZone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropZone.classList.add('dragover'); });
      dropZone.addEventListener('dragleave', ()=> dropZone.classList.remove('dragover'));
      dropZone.addEventListener('drop', (e)=>{
        e.preventDefault(); dropZone.classList.remove('dragover');
        if(e.dataTransfer.files.length){ fileInput.files = e.dataTransfer.files; handleFile(e.dataTransfer.files[0]); }
      });
      fileInput.addEventListener('change', ()=> handleFile(fileInput.files[0]));

      // Obtener imagen desde URL
      fetchButton.addEventListener('click', async ()=>{
        const url = urlInput.value.trim();
        if(!url){ showStatus('Ingres√° una URL primero.', 'error'); return; }
        try{ new URL(url); }catch{ showStatus('Ingres√° una URL v√°lida.', 'error'); return; }

        setFetchLoading(true);
        urlFeedback.textContent = 'Buscando imagen...';
        urlFeedback.className = 'mt-2 text-xs text-sky-400 h-8';

        fileInput.value=''; imagePreview.src=''; imagePreview.classList.add('hidden'); uploadPrompt.classList.remove('hidden');

        try{
          const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
          const response = await fetch(proxyUrl);
          if(!response.ok) throw new Error(`No se pudo obtener la URL (status ${response.status})`);
          const htmlText = await response.text();
          const doc = new DOMParser().parseFromString(htmlText,'text/html');
          const ogImageTag = doc.querySelector('meta[property="og:image"]');

          if(ogImageTag && ogImageTag.content){
            const imageUrl = new URL(ogImageTag.content, url).href;
            appState.image = imageUrl; appState.source = 'url';
            urlPreviewImg.src = imageUrl; urlPreviewImg.classList.remove('hidden');
            urlPreviewPlaceholder.classList.add('hidden');
            urlFeedback.textContent = '‚úÖ ¬°Listo! Se encontr√≥ la imagen.';
            urlFeedback.className = 'mt-2 text-xs text-emerald-400 h-8';
            handleImageSelection();
          }else{
            throw new Error('La p√°gina no tiene meta og:image.');
          }
        }catch(error){
          console.error('Fetch error:', error);
          urlFeedback.textContent = `‚ùå Error: ${error.message}`;
          urlFeedback.className = 'mt-2 text-xs text-rose-400 h-8';
          appState.image=null; appState.source=null; clearUrlState();
        }finally{
          setFetchLoading(false);
        }
      });

      // Analizar imagen (prompts)
      analyzeButton.addEventListener('click', async ()=>{
        if(!PROMPT_GENERATION_WEBHOOK_URL){ showStatus('Falta configurar el Webhook de generaci√≥n de prompts.', 'error'); return; }
        if(!appState.image){ showStatus('Carg√° una imagen primero.', 'error'); return; }

        setAnalyzeLoading(true);
        showStatus('Analizando imagen...', 'loading');

        try{
          const response = await fetch(PROMPT_GENERATION_WEBHOOK_URL,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ image:appState.image, source:appState.source })
          });
          if(!response.ok) throw new Error(`El servidor respondi√≥ con status ${response.status}`);

          const contentType = response.headers.get("content-type");
          if(!contentType || !contentType.includes("application/json")){
            const errorText = await response.text();
            console.error("Respuesta no-JSON del webhook:", errorText);
            throw new TypeError("El webhook devolvi√≥ un contenido no-JSON. Revis√° el flujo en n8n.");
          }

          let data = await response.json();
          if(Array.isArray(data) && data.length>0) data = data[0];
          let promptData = data.json || data;

          if(promptData && promptData.music_prompt && promptData.voiceover_prompt){
            renderPromptOptions(promptData);
            videoSizeSection.classList.remove('hidden');
            advancedOptionsSection.classList.remove('hidden');
            promptSection.classList.remove('hidden');
            analyzeSection.classList.add('hidden');
            showStatus('‚úÖ An√°lisis completo. Eleg√≠ un prompt.', 'success');
          }else{
            throw new Error("Faltan 'music_prompt' o 'voiceover_prompt' en la respuesta.");
          }
        }catch(error){
          console.error('Prompt generation error:', error);
          showStatus(`‚ùå Error obteniendo prompts: ${error.message}`, 'error');
        }finally{
          setAnalyzeLoading(false);
        }
      });

      function renderPromptOptions(prompts){
        const musicPrompt = prompts.music_prompt;
        const voiceoverPrompt = prompts.voiceover_prompt;

        promptOptionsContainer.innerHTML = `
          <div class="relative">
            <input type="radio" name="prompt_choice" id="prompt-music" value="${musicPrompt}" class="hidden prompt-card-radio">
            <label for="prompt-music" class="block p-4 border border-white/15 rounded-lg cursor-pointer hover:border-indigo-400 transition-colors glass-soft">
              <span class="font-semibold">Video con m√∫sica</span>
              <p class="text-sm text-white/70 mt-1">${musicPrompt}</p>
            </label>
          </div>
          <div class="relative">
            <input type="radio" name="prompt_choice" id="prompt-ai" value="${voiceoverPrompt}" class="hidden prompt-card-radio">
            <label for="prompt-ai" class="block p-4 border border-white/15 rounded-lg cursor-pointer hover:border-indigo-400 transition-colors glass-soft">
              <span class="font-semibold">Video con voz en off</span>
              <p class="text-sm text-white/70 mt-1">${voiceoverPrompt}</p>
            </label>
          </div>
          <div>
            <div class="relative">
              <input type="radio" name="prompt_choice" id="prompt-custom-radio" value="custom" class="hidden prompt-card-radio">
              <label for="prompt-custom-radio" class="block p-4 border border-white/15 rounded-lg cursor-pointer hover:border-indigo-400 transition-colors glass-soft">
                <span class="font-semibold">Escrib√≠ tu propio prompt</span>
                <p class="text-sm text-white/70 mt-1">Ingresalo manualmente en el campo de abajo.</p>
              </label>
            </div>
            <textarea id="custom-prompt-textarea" rows="4" class="mt-3 block w-full input disabled:opacity-60" placeholder="Ej.: Hac√© que la persona de la imagen hable..." disabled></textarea>
          </div>
        `;
        promptOptionsContainer.addEventListener('change', handlePromptSelection);
      }

      function handlePromptSelection(e){
        const customTextarea = document.getElementById('custom-prompt-textarea');
        if(e.target.name === 'prompt_choice'){
          const isCustom = e.target.value === 'custom';
          customTextarea.disabled = !isCustom;
          if(isCustom){ customTextarea.focus(); appState.prompt = customTextarea.value; }
          else{ appState.prompt = e.target.value; }
          submitButton.disabled = !appState.prompt;
        }
      }

      promptOptionsContainer.addEventListener('input', (e)=>{
        if(e.target.id === 'custom-prompt-textarea'){
          appState.prompt = e.target.value;
          submitButton.disabled = !appState.prompt;
        }
      });

      // Crear video
      submitButton.addEventListener('click', async ()=>{
        if(!CREATE_VIDEO_WEBHOOK_URL){ showStatus('Falta configurar el Webhook principal.', 'error'); return; }
        if(!appState.image){ showStatus('Sub√≠ una imagen o peg√° una URL.', 'error'); return; }
        if(!appState.prompt || appState.prompt.trim()===''){ showStatus('Eleg√≠ o escrib√≠ un prompt.', 'error'); return; }

        setLoading(true);
        showStatus('Iniciando la creaci√≥n del video...', 'loading');

        const payload = {
          image: appState.image,
          source: appState.source,
          prompt: appState.prompt.trim(),
          aspect_ratio: aspectRatioSelect.value,
          model: modelSelect.value,
          seed: seedInput.value.trim(),
          watermark: watermarkInput.value.trim()
        };
        if(payload.seed==='') delete payload.seed;
        if(payload.watermark==='') delete payload.watermark;

        try{
          const initialResponse = await fetch(CREATE_VIDEO_WEBHOOK_URL,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify(payload)
          });
          if(!initialResponse.ok) throw new Error(`Fallo la solicitud inicial (status ${initialResponse.status})`);

          let data = await initialResponse.json();
          if(Array.isArray(data) && data.length>0) data = data[0];
          currentJobId = data.job_id || data.json?.job_id;
          if(!currentJobId) throw new Error("El servidor no devolvi√≥ 'job_id'.");

          jobIdDisplay.textContent = `Job ID: ${currentJobId}`;
          mainContent.classList.add('hidden');
          checkProgressSection.classList.remove('hidden');
          statusMessage.textContent = '';
        }catch(error){
          console.error('Error starting video creation:', error);
          showStatus(`‚ùå Error: ${error.message}. Mir√° la consola para m√°s detalles.`, 'error');
        }finally{
          setLoading(false);
        }
      });

      // Ver estado
      checkProgressButton.addEventListener('click', async ()=>{
        if(!VIDEO_STATUS_WEBHOOK_URL){ showStatus('Falta configurar el Webhook de estado.', 'error'); return; }
        if(!currentJobId){ showStatus('No hay un trabajo activo.', 'error'); return; }

        setCheckProgressLoading(true);
        showStatus('Consultando estado...', 'loading');

        try{
          const statusResponse = await fetch(VIDEO_STATUS_WEBHOOK_URL,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ job_id: currentJobId })
          });
          if(!statusResponse.ok) throw new Error(`No se pudo consultar el estado (status ${statusResponse.status})`);

          const statusData = await statusResponse.json();
          if(Array.isArray(statusData) && statusData.length>0 && statusData[0].video_url){
            const videoUrl = statusData[0].video_url;
            videoModalPanel.classList.remove('sm:max-w-4xl','sm:max-w-7xl','sm:max-w-2xl');
            videoModalPanel.classList.add('sm:max-w-xl');
            videoPlayer.src = videoUrl;
            videoModal.classList.remove('hidden');
            showStatus('‚úÖ ¬°Video creado con √©xito!', 'success');
            resetState();
          }else{
            showStatus('El video todav√≠a no est√° listo. Prob√° de nuevo en un momento.', 'loading');
          }
        }catch(error){
          console.error('Polling error:', error);
          showStatus(`‚ùå Error consultando el estado: ${error.message}`, 'error');
        }finally{
          setCheckProgressLoading(false);
        }
      });

      startOverButton.addEventListener('click', resetState);

      closeModalButton.addEventListener('click', ()=>{
        videoModal.classList.add('hidden'); videoPlayer.src='';
      });
      resizeVideoButton.addEventListener('click', ()=>{
        if(videoModalPanel.classList.contains('sm:max-w-xl')){
          videoModalPanel.classList.remove('sm:max-w-xl'); videoModalPanel.classList.add('sm:max-w-4xl');
        }else if(videoModalPanel.classList.contains('sm:max-w-4xl')){
          videoModalPanel.classList.remove('sm:max-w-4xl'); videoModalPanel.classList.add('sm:max-w-7xl');
        }else{
          videoModalPanel.classList.remove('sm:max-w-7xl'); videoModalPanel.classList.add('sm:max-w-xl');
        }
      });

      function resetState(){
        form.reset();
        mainContent.classList.remove('hidden');
        checkProgressSection.classList.add('hidden');
        imagePreview.classList.add('hidden');
        uploadPrompt.classList.remove('hidden');
        fileInput.value='';
        clearUrlState();
        analyzeSection.classList.add('hidden');
        videoSizeSection.classList.add('hidden');
        advancedOptionsSection.classList.add('hidden');
        promptSection.classList.add('hidden');
        submitButton.disabled = true;
        currentJobId = null;
        appState = { image:null, source:null, prompt:null };
        setTimeout(()=>{ showStatus('', null); }, 5000);
      }
    });
  </script>
</body>
</html>
